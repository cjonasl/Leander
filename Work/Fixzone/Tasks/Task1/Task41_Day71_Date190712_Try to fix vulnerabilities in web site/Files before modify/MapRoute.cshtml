@using CAST.Controllers
@model CAST.Models.MapModel
@{
    ViewBag.Title = "MapRoute";
}

<head>
    <style>
        #map_canvas {
            float: left;
            height: 700px;
            width: 100%;
        }
    </style>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <title>Track Engineer</title>
    <link rel="stylesheet" type="text/css" src="~/style.css">

    <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyBucjJ0FsS0bNlVickWom69CD5uVKcQsnY"></script>

    <script type="text/javascript" src="~/scripts/eploy.js"></script>
    <script type="text/javascript" src="~/Scripts/jquery-1.8.2.js"></script>
    <script type="text/javascript" src="~/scripts/mapRouteScript.js"></script>
</head>
<body onload="initialize()">

    <div id="tools" class="section section__full">
        <span class="section__heading">
            Track your Engineer
        </span>

        <script type="text/javascript">

        $(document).ready(function() {
            @*var p1 = '@Model.EngLastPosLat,@Model.EngLastPosLng';
            var p2 = '@Model.CustomerPostCode';
            var waypoints = '@Model.WayPointList';
            var serviceid = '@Model.ServiceID';*@
            const Quarter_Hour_MILISECONDS = 900000;

            function doAction(action) {
                var results;
                $.ajax({
                    url: action,
                    data: JSON.stringify({ serviceId: @Model.ServiceID }),
                        dataType: 'json',
                        contentType: 'application/json; charset=utf-8',
                        async: false,
                        type: 'POST',
                        success: function (result) {
                            results = result;
                        }
                    });
                    return results;
                }

                //Search for Engineer In Path
                function SearchEngPos() {
                    return doAction('/Map/FindEngInPath');
                }

            $(window).load(function(e) {
                    e.preventDefault();

               //setRoutes(p1, p2, waypoints, serviceid)};
                    setRoutes({
                        startPoint: '@Model.EngLastPosLat,@Model.EngLastPosLng',
                        endPoint: '@Model.CustomerPostCode',
                        strDestinations: '@Model.WayPointList',
                        serviceID: '@Model.ServiceID'
                    });

                var firstTimer = setInterval(function () {
                    var result = SearchEngPos();
                    if (!result.success && result.coords !=="") {
                        setRoutes({
                            startPoint: result.coords,
                            endPoint: '@Model.CustomerPostCode',
                            strDestinations: '@Model.WayPointList',
                            serviceID: '@Model.ServiceID'
                        });
                    }
                    if (result.success && result.Message === "Engineer is at destination."){
                        clearInterval(firstTimer);
                    }
                }, Quarter_Hour_MILISECONDS);

                 }
            );

        });
        </script>

        @if (ViewBag.ErrorMsg != null)
        {
            <h5 style="color:red">@ViewBag.ErrorMsg</h5>
        }

        <table class="data__simple">
            <tr>
                <td>Estimated Arrival Time: </td>
                <td><div id="EstimatedTime"></div></td>

                <td>Remaining Time: </td>
                <td><div id="remainTime"> </div></td>
            </tr>
        </table>

        <div id="error-msg"></div>
        <div id="durationTime"></div>
        <div id="map_canvas"></div>
    </div>

</body>